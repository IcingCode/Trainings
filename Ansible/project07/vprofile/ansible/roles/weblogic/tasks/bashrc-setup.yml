---
- name: Create WebLogic backup directory
  ansible.builtin.file:
    path: "{{ oracle_base }}/backups/weblogic"
    state: directory
    mode: '0755'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
  become: true
  tags:
    - weblogic-bashrc-backup-directory

- name: Backup existing .bashrc if it exists
  ansible.builtin.copy:
    src: "{{ oracle_base }}/.bashrc"
    dest: "{{ oracle_base }}/.bashrc.backup.{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
  become: true
  when: ansible_stat_result.stat.exists
  vars:
    ansible_stat_result: "{{ bashrc_stat_result | default({'stat': {'exists': false}}) }}"
  tags:
    - weblogic-bashrc-backup

- name: Check if .bashrc exists
  ansible.builtin.stat:
    path: "{{ oracle_base }}/.bashrc"
  register: bashrc_stat_result
  tags:
    - weblogic-bashrc-check

- name: Deploy WebLogic management .bashrc for oracle user
  ansible.builtin.template:
    src: weblogic-bashrc.j2
    dest: "{{ oracle_base }}/.bashrc"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
    backup: false
  become: true
  register: bashrc_deployed
  tags:
    - weblogic-bashrc-deploy

- name: Set appropriate permissions on .bashrc
  ansible.builtin.file:
    path: "{{ oracle_base }}/.bashrc"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
  become: true
  tags:
    - weblogic-bashrc-permissions

- name: Create .bash_profile that sources .bashrc if needed
  ansible.builtin.copy:
    dest: "{{ oracle_base }}/.bash_profile"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
    content: |
      # .bash_profile for {{ weblogic_user }}
      # Generated by Ansible

      # Get the aliases and functions
      if [ -f ~/.bashrc ]; then
          . ~/.bashrc
      fi

      # User specific environment and startup programs
      PATH=$PATH:$HOME/.local/bin:$HOME/bin
      export PATH
    force: false
  become: true
  tags:
    - weblogic-bash-profile

- name: Validate .bashrc syntax
  ansible.builtin.shell: |
    bash -n {{ oracle_base }}/.bashrc
  become: true
  become_user: "{{ weblogic_user }}"
  register: bashrc_syntax_check
  failed_when: bashrc_syntax_check.rc != 0
  tags:
    - weblogic-bashrc-validate

- name: Test WebLogic functions are available
  ansible.builtin.shell: |
    source {{ oracle_base }}/.bashrc
    type wls_help >/dev/null 2>&1 && echo "SUCCESS" || echo "FAILED"
  become: true
  become_user: "{{ weblogic_user }}"
  args:
    executable: /bin/bash
  register: bashrc_function_test
  failed_when: "'SUCCESS' not in bashrc_function_test.stdout"
  tags:
    - weblogic-bashrc-test

- name: Display WebLogic .bashrc deployment summary
  ansible.builtin.debug:
    msg: |
      
      ╔══════════════════════════════════════════════════════════════════════════════╗
      ║                     WebLogic .bashrc Deployment Summary                      ║
      ╠══════════════════════════════════════════════════════════════════════════════╣
      ║                                                                              ║
      ║  ✅ Status: {{ 'DEPLOYED SUCCESSFULLY' if bashrc_deployed.changed else 'ALREADY UP-TO-DATE' }}                                                    ║
      ║  👤 User: {{ weblogic_user }}                                                            ║
      ║  📁 Path: {{ oracle_base }}/.bashrc                                              ║
      ║  🏠 Domain: {{ weblogic_domain_name }}                                                   ║
      ║  🌐 Admin Console: http://{{ ansible_default_ipv4.address }}:{{ weblogic_admin_port }}/console       ║
      ║                                                                              ║
      ║  🎯 Features Included:                                                       ║
      ║    • Color-coded prompt with real-time WebLogic status                      ║
      ║    • ASCII art welcome screen with system information                       ║
      ║    • 15+ WebLogic management functions (wls_start, wls_stop, etc.)          ║
      ║    • Comprehensive health monitoring (wls_health)                           ║
      ║    • Log viewing utilities (wls_logs [server|domain|access|systemd])        ║
      ║    • Configuration backup utility (wls_backup)                              ║
      ║    • Browser-based console launcher (wls_console)                           ║
      ║    • Useful aliases and navigation shortcuts                                ║
      ║    • Enhanced bash history and completion                                   ║
      ║                                                                              ║
      ║  🚀 Next Steps:                                                              ║
      ║    1. Login as '{{ weblogic_user }}' user: sudo su - {{ weblogic_user }}                           ║
      ║    2. Type 'wls_help' to see all available commands                         ║
      ║    3. Try 'wls_status' to check WebLogic server status                      ║
      ║    4. Use 'wls_console' to open the admin console                           ║
      ║                                                                              ║
      ╚══════════════════════════════════════════════════════════════════════════════╝
      
  tags:
    - weblogic-bashrc-summary

- name: Create quick reference guide
  ansible.builtin.copy:
    dest: "{{ oracle_base }}/weblogic_commands.txt"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
    content: |
      ===============================================================================
                          WEBLOGIC MANAGEMENT COMMANDS REFERENCE
      ===============================================================================
      Domain: {{ weblogic_domain_name }}
      Admin Console: http://{{ ansible_default_ipv4.address }}:{{ weblogic_admin_port }}/console
      Generated: {{ ansible_date_time.iso8601 }}
      ===============================================================================

      🚀 SERVICE MANAGEMENT:
      ----------------------
      wls_start       - Start WebLogic AdminServer
      wls_stop        - Stop WebLogic AdminServer  
      wls_restart     - Restart WebLogic AdminServer
      wls_status      - Show detailed server status

      📊 MONITORING & DIAGNOSTICS:
      ----------------------------
      wls_logs [type] - View logs (server|domain|access|systemd)
                        Examples: wls_logs server, wls_logs systemd
      wls_ports       - Show active network ports
      wls_processes   - Show Java processes
      wls_health      - Comprehensive health check with scoring
      wls_memory      - Show memory usage analysis
      wls_threads     - Generate thread dump

      ⚙️  CONFIGURATION & MANAGEMENT:
      --------------------------------
      wls_config      - Show configuration summary
      wls_console     - Open admin console in browser
      wls_backup      - Create configuration backup

      🎨 SYSTEM UTILITIES:
      -------------------
      wls_welcome     - Show welcome screen with status
      wls_help        - Show detailed help message

      🔗 USEFUL ALIASES:
      ------------------
      wl              → wls_status
      wstart          → wls_start
      wstop           → wls_stop
      wrestart        → wls_restart
      wconsole        → wls_console
      wconfig         → wls_config
      whealth         → wls_health
      wlogs           → wls_logs server

      📁 NAVIGATION ALIASES:
      ----------------------
      cddomain        → cd {{ domain_home }}
      cdlogs          → cd {{ domain_home }}/servers/AdminServer/logs
      cdbin           → cd {{ domain_home }}/bin
      cdconfig        → cd {{ domain_home }}/config

      💡 TIPS:
      --------
      • All commands provide color-coded output for easy reading
      • Your prompt shows real-time WebLogic server status
      • Backup location: {{ oracle_base }}/backups/weblogic/
      • Press Ctrl+C to exit log viewing commands

      ===============================================================================
  become: true
  tags:
    - weblogic-bashrc-reference

---
- name: Create WebLogic backup directory
  ansible.builtin.file:
    path: "{{ oracle_base }}/backups/weblogic"
    state: directory
    mode: '0755'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
  become: true
  tags:
    - weblogic-bashrc-backup-directory

- name: Backup existing .bashrc if it exists
  ansible.builtin.copy:
    src: "{{ oracle_base }}/.bashrc"
    dest: "{{ oracle_base }}/.bashrc.backup.{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
  become: true
  when: ansible_stat_result.stat.exists
  vars:
    ansible_stat_result: "{{ bashrc_stat_result | default({'stat': {'exists': false}}) }}"
  tags:
    - weblogic-bashrc-backup

- name: Check if .bashrc exists
  ansible.builtin.stat:
    path: "{{ oracle_base }}/.bashrc"
  register: bashrc_stat_result
  tags:
    - weblogic-bashrc-check

- name: Deploy WebLogic management .bashrc for oracle user
  ansible.builtin.template:
    src: weblogic-bashrc.j2
    dest: "{{ oracle_base }}/.bashrc"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
    backup: false
  become: true
  register: bashrc_deployed
  tags:
    - weblogic-bashrc-deploy

- name: Set appropriate permissions on .bashrc
  ansible.builtin.file:
    path: "{{ oracle_base }}/.bashrc"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
  become: true
  tags:
    - weblogic-bashrc-permissions

- name: Create .bash_profile that sources .bashrc if needed
  ansible.builtin.copy:
    dest: "{{ oracle_base }}/.bash_profile"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
    content: |
      # .bash_profile for {{ weblogic_user }}
      # Generated by Ansible

      # Get the aliases and functions
      if [ -f ~/.bashrc ]; then
          . ~/.bashrc
      fi

      # User specific environment and startup programs
      PATH=$PATH:$HOME/.local/bin:$HOME/bin
      export PATH
    force: false
  become: true
  tags:
    - weblogic-bash-profile

- name: Validate .bashrc syntax
  ansible.builtin.shell: |
    bash -n {{ oracle_base }}/.bashrc
  become: true
  become_user: "{{ weblogic_user }}"
  register: bashrc_syntax_check
  failed_when: bashrc_syntax_check.rc != 0
  tags:
    - weblogic-bashrc-validate

- name: Test WebLogic functions are available
  ansible.builtin.shell: |
    source {{ oracle_base }}/.bashrc
    type wls_help >/dev/null 2>&1 && echo "SUCCESS" || echo "FAILED"
  become: true
  become_user: "{{ weblogic_user }}"
  args:
    executable: /bin/bash
  register: bashrc_function_test
  failed_when: "'SUCCESS' not in bashrc_function_test.stdout"
  tags:
    - weblogic-bashrc-test

- name: Display WebLogic .bashrc deployment summary
  ansible.builtin.debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                     WebLogic .bashrc Deployment Summary                      â•‘
      â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
      â•‘                                                                              â•‘
      â•‘  âœ… Status: {{ 'DEPLOYED SUCCESSFULLY' if bashrc_deployed.changed else 'ALREADY UP-TO-DATE' }}                                                    â•‘
      â•‘  ğŸ‘¤ User: {{ weblogic_user }}                                                            â•‘
      â•‘  ğŸ“ Path: {{ oracle_base }}/.bashrc                                              â•‘
      â•‘  ğŸ  Domain: {{ weblogic_domain_name }}                                                   â•‘
      â•‘  ğŸŒ Admin Console: http://{{ ansible_default_ipv4.address }}:{{ weblogic_admin_port }}/console       â•‘
      â•‘                                                                              â•‘
      â•‘  ğŸ¯ Features Included:                                                       â•‘
      â•‘    â€¢ Color-coded prompt with real-time WebLogic status                      â•‘
      â•‘    â€¢ ASCII art welcome screen with system information                       â•‘
      â•‘    â€¢ 15+ WebLogic management functions (wls_start, wls_stop, etc.)          â•‘
      â•‘    â€¢ Comprehensive health monitoring (wls_health)                           â•‘
      â•‘    â€¢ Log viewing utilities (wls_logs [server|domain|access|systemd])        â•‘
      â•‘    â€¢ Configuration backup utility (wls_backup)                              â•‘
      â•‘    â€¢ Browser-based console launcher (wls_console)                           â•‘
      â•‘    â€¢ Useful aliases and navigation shortcuts                                â•‘
      â•‘    â€¢ Enhanced bash history and completion                                   â•‘
      â•‘                                                                              â•‘
      â•‘  ğŸš€ Next Steps:                                                              â•‘
      â•‘    1. Login as '{{ weblogic_user }}' user: sudo su - {{ weblogic_user }}                           â•‘
      â•‘    2. Type 'wls_help' to see all available commands                         â•‘
      â•‘    3. Try 'wls_status' to check WebLogic server status                      â•‘
      â•‘    4. Use 'wls_console' to open the admin console                           â•‘
      â•‘                                                                              â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
  tags:
    - weblogic-bashrc-summary

- name: Create quick reference guide
  ansible.builtin.copy:
    dest: "{{ oracle_base }}/weblogic_commands.txt"
    mode: '0644'
    owner: "{{ weblogic_user }}"
    group: "{{ weblogic_group }}"
    content: |
      ===============================================================================
                          WEBLOGIC MANAGEMENT COMMANDS REFERENCE
      ===============================================================================
      Domain: {{ weblogic_domain_name }}
      Admin Console: http://{{ ansible_default_ipv4.address }}:{{ weblogic_admin_port }}/console
      Generated: {{ ansible_date_time.iso8601 }}
      ===============================================================================

      ğŸš€ SERVICE MANAGEMENT:
      ----------------------
      wls_start       - Start WebLogic AdminServer
      wls_stop        - Stop WebLogic AdminServer  
      wls_restart     - Restart WebLogic AdminServer
      wls_status      - Show detailed server status

      ğŸ“Š MONITORING & DIAGNOSTICS:
      ----------------------------
      wls_logs [type] - View logs (server|domain|access|systemd)
                        Examples: wls_logs server, wls_logs systemd
      wls_ports       - Show active network ports
      wls_processes   - Show Java processes
      wls_health      - Comprehensive health check with scoring
      wls_memory      - Show memory usage analysis
      wls_threads     - Generate thread dump

      âš™ï¸  CONFIGURATION & MANAGEMENT:
      --------------------------------
      wls_config      - Show configuration summary
      wls_console     - Open admin console in browser
      wls_backup      - Create configuration backup

      ğŸ¨ SYSTEM UTILITIES:
      -------------------
      wls_welcome     - Show welcome screen with status
      wls_help        - Show detailed help message

      ğŸ”— USEFUL ALIASES:
      ------------------
      wl              â†’ wls_status
      wstart          â†’ wls_start
      wstop           â†’ wls_stop
      wrestart        â†’ wls_restart
      wconsole        â†’ wls_console
      wconfig         â†’ wls_config
      whealth         â†’ wls_health
      wlogs           â†’ wls_logs server

      ğŸ“ NAVIGATION ALIASES:
      ----------------------
      cddomain        â†’ cd {{ domain_home }}
      cdlogs          â†’ cd {{ domain_home }}/servers/AdminServer/logs
      cdbin           â†’ cd {{ domain_home }}/bin
      cdconfig        â†’ cd {{ domain_home }}/config

      ğŸ’¡ TIPS:
      --------
      â€¢ All commands provide color-coded output for easy reading
      â€¢ Your prompt shows real-time WebLogic server status
      â€¢ Backup location: {{ oracle_base }}/backups/weblogic/
      â€¢ Press Ctrl+C to exit log viewing commands

      ===============================================================================
  become: true
  tags:
    - weblogic-bashrc-reference
